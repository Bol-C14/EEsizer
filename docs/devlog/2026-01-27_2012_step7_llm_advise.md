# 2026-01-27 2012 Step7 LLM advise + accept/reject (schema-validated)

- Added Step7 LLM output contracts (hard safety boundary):
  - `src/eesizer_core/contracts/llm_insights.py` (`INSIGHTS_SCHEMA`, `validate_llm_insights`)
  - `src/eesizer_core/contracts/llm_proposal.py` (`PROPOSAL_SCHEMA`, `validate_llm_proposal`)
- Added deterministic context + prompt + strict JSON parsing utilities:
  - `src/eesizer_core/operators/llm_context/build_context.py`
  - `src/eesizer_core/operators/llm_prompt/build_report_interpret_prompt.py`
  - `src/eesizer_core/operators/llm_prompt/build_tool_plan_prompt.py`
  - `src/eesizer_core/operators/llm_parse/parse_json_with_schema.py` (strict JSON + validate_fn, plus repair prompt helper)
- Added Step7 operator: `src/eesizer_core/operators/session_llm_advice.py`
  - Two-stage flow:
    - Agent A (ReportInterpreterAgent) → `insights.json`
    - Agent B (ToolPlannerAgent) → `proposal.json` (multi-option)
  - Deterministic artifacts + cache:
    - `session/llm/context_revNNNN.json`
    - `session/llm/advice/advice_revNNNN/{context.json,prompt_*.txt,response_*.txt,insights.json,proposal.json,validation.json,status.json}`
    - `session/llm/cache_index.json` (hash-keyed reuse)
  - Robust parsing: schema-validated JSON only; optional repair loop (`max_repairs`)
  - Keeps deterministic reports clean: writes `session/llm/narrative.md` and links it from `session/meta_report.md`
- Session plumbing updates for Step7:
  - `src/eesizer_core/contracts/session.py`: `latest_advice_rev`, `advice_history`
  - `src/eesizer_core/runtime/session_store.py`: `mark_advice_decision()` updates `status.json` + `session_state.advice_history`
  - `src/eesizer_core/analysis/session_report.py`: adds “LLM Interpretation (Optional)” section when present
- CLI entrypoint extended: `tools/session/run_session.py`
  - New commands: `advise`, `show-advice`, `accept`, `reject`
  - Offline-friendly: `--mock` measure_fn and `--mock-llm` canned responses
- Added Step7 tests (no ngspice required; OpenAI integration is auto-skip without key):
  - `tests/test_step7_*`

Quick checks:
- `pytest -q tests/test_step7_*`
- Mock end-to-end (no ngspice / no API):
  - `PYTHONPATH=src python tools/session/run_session.py new --bench ota --run-to-phase p1_grid --mock`
  - `PYTHONPATH=src python tools/session/run_session.py advise --session-run-dir <run_dir> --provider mock --mock-llm`
  - `PYTHONPATH=src python tools/session/run_session.py show-advice --session-run-dir <run_dir>`
  - `PYTHONPATH=src python tools/session/run_session.py accept --session-run-dir <run_dir> --option-index 0 --next-phase p1_grid --mock`

